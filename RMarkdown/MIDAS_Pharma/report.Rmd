---
title: "Visualisations for Pharma Project (MIDAS data)"
author: "Will Cuningham | ADILA"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r prep, include=FALSE}
# packages
rm(list = ls()) 
packages <- c("dplyr","tidyr","ggplot2","plotly","data.table")
new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)
lapply(packages, require, character.only = TRUE)

# import data
data_original <- read.csv("O://formatted_data/amu_data/row_level_ddd.csv")

# clean & format
data_reformatted <- data_original %>% 
  select(country, country_iso3_code, corporation, corp_amr_alliance, corp_ifpma, aware_category, route_of_administration, effective_from, standard_units, ddd) %>%
  mutate(year = as.numeric(gsub("-01-01", "", effective_from))) %>% select(-effective_from) %>% rename(su = standard_units)
  # reshaping wide to long
  data_reformatted <- gather(data_reformatted, metric, value, su, ddd, factor_key = TRUE)
  # collapsing stratification in other categories (e.g., age_appropriate (true/false), etc.)
  data_for_report <- data_reformatted %>% 
    group_by(country, country_iso3_code, corporation, corp_amr_alliance, corp_ifpma, aware_category, route_of_administration, year, metric) %>%
    summarize(value = sum(value, na.rm = TRUE), .groups = "keep") %>%
    ungroup()

# collapse to create "All" subgroups
  # "All" in all three groups
  subset_all_3 <- data_for_report %>% group_by(corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>% 
    mutate(country = "All", country_iso3_code = "All", aware_category = "All", route_of_administration = "All") %>%
    ungroup()
  # "All" in any two of the three groups
  subset_country_2 <- data_for_report %>% group_by(country, country_iso3_code, corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>% 
    mutate(aware_category = "All", route_of_administration = "All") %>%
    ungroup()
  subset_aware_2 <- data_for_report %>% group_by(aware_category, corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>% 
    mutate(country = "All", country_iso3_code = "All", route_of_administration = "All") %>%
    ungroup()
  subset_route_2 <- data_for_report %>% group_by(route_of_administration, corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>% 
    mutate(country = "All", country_iso3_code = "All", aware_category = "All") %>%
    ungroup()
  # "All" in only one of the three groups
  subset_country_1 <- data_for_report %>% group_by(route_of_administration, aware_category, corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>% 
    mutate(country = "All", country_iso3_code = "All") %>%
    ungroup()
  subset_route_1 <- data_for_report %>% group_by(country, country_iso3_code, aware_category, corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>% 
    mutate(route_of_administration = "All") %>%
    ungroup()
  subset_aware_1 <- data_for_report %>% group_by(country, country_iso3_code, route_of_administration, corporation, corp_amr_alliance, corp_ifpma, year, metric) %>% summarise(value = sum(value, na.rm = TRUE), .groups = "keep") %>%
    mutate(aware_category = "All") %>%
    ungroup()
  # append each of these subsets to the main dataset
  data_for_report <- rbind(data_for_report, 
                           subset_all_3,
                           subset_country_2, subset_aware_2, subset_route_2, 
                           subset_country_1, subset_aware_1, subset_route_1
                          )
  rm(list = ls(pattern = "subset_"))
```

## Descriptive summary

This report is intended to help analyse and visualise the IQVIA MIDAS dataset as part of the ADILA project. In particular, it focuses on describing the corporations contributing most to AMC.

This dataset includes AMC data in `r length(unique(data_for_report$country))` countries between `r min(data_for_report$year, na.rm = T)` and `r max(data_for_report$year, na.rm = T)`, supplied by `r length(unique(data_for_report$corporation))` corporations.

```{r stats, include=FALSE}
# calculate percentage by route
per_by_route <- data_for_report %>%
  filter(year == 2019 & metric == "su" & country == "All" & aware_category == "All" & route_of_administration != "All") %>%
  mutate(percent = round((value/sum(value))*100, 5))
per_oral <- per_by_route[per_by_route$route_of_administration == "Oral", ]
per_parenteral <- per_by_route[per_by_route$route_of_administration == "Parenteral", ]
  
# calculate percentage by AWaRe
per_by_aware <- data_for_report %>%
  filter(year == 2019 & metric == "su" & country == "All" & route_of_administration == "All" & aware_category != "All") %>%
  mutate(percent = round((value/sum(value))*100, 5))
per_access <- per_by_aware[per_by_aware$aware_category == "Access", ]
per_watch <- per_by_aware[per_by_aware$aware_category == "Watch", ]
per_reserve <- per_by_aware[per_by_aware$aware_category == "Reserve", ]

# calculate number of corporations in DU90
DU90_corp <- data_for_report %>%
  filter(year == 2019 & metric == "su" & country == "All" & aware_category == "All" & route_of_administration == "All") %>%
  mutate(percent = round((value/sum(value))*100, 5))
DU90_corp <- DU90_corp[order(-DU90_corp$percent, DU90_corp$corporation), ] %>%
  mutate(cumulative = cumsum(percent)) %>%
  filter(cumulative <= 90)
  # calculate percentage of these that are in each alliance
  alliance <- DU90_corp %>%
    mutate(count_amr = case_when(corp_amr_alliance == "true" & corp_ifpma == "false" ~ 1),
           count_ifpma = case_when(corp_amr_alliance == "false" & corp_ifpma == "true" ~ 1),
           count_both = case_when(corp_amr_alliance == "true" & corp_ifpma == "true" ~ 1),
           count_neither = case_when(corp_amr_alliance == "false" & corp_ifpma == "false" ~ 1))
```

Globally in 2019, oral and parenteral antibiotics accounted for `r round(sum(per_oral$percent), 2)`% and `r round(sum(per_parenteral$percent), 2)`% of AMC respectively. "Access" antibiotics accounted for `r round(sum(per_access$percent), 2)`%, "Watch" `r round(sum(per_watch$percent), 2)`%, and "Reserve" `r round(sum(per_reserve$percent), 2)`%. `r length(unique(DU90_corp$corporation))` (`r round((length(unique(DU90_corp$corporation))/length(unique(data_for_report$corporation)))*100, 2)`%) of the corporations contributed to 90% of AMC. Of these corporations, `r round((sum(alliance$count_amr, na.rm = T)/length(unique(DU90_corp$corporation)))*100, 2)`% were part of the AMR Alliance only, `r round((sum(alliance$count_ifpma, na.rm = T)/length(unique(DU90_corp$corporation)))*100, 2)`% part of the IFPMA only, and `r round((sum(alliance$count_both, na.rm = T)/length(unique(DU90_corp$corporation)))*100, 2)`% part of both.

## Explore DU90 (by corporation)

Please use the Shiny app below to reveal which corporations contribute most to AMC.

```{r DU90_corp, echo=FALSE}
shinyApp(
  
  ui = fluidPage(
    
    # inputs
    inputPanel(
      selectInput("country", label = "Country:",
                  choices = c("", sort(unique(data_for_report$country))),
                  selected = NULL, 
                  multiple = FALSE
                  ),
      selectInput("route", label = "Route of administration:",
                  choices = c("", sort(unique(data_for_report$route_of_administration))),
                  selected = NULL, 
                  multiple = FALSE
                 ),
      selectInput("aware", label = "AWaRe category:",
                  choices = c("", sort(unique(data_for_report$aware_category))),
                  selected = NULL, 
                  multiple = FALSE
                  ),
      sliderInput("year", label = "Year(s):",
                  value = c(min(data_for_report$year, na.rm = T), max(data_for_report$year, na.rm = T)),
                  min = min(data_for_report$year, na.rm = T),
                  max = max(data_for_report$year, na.rm = T),
                  step = 1,
                  sep = "",
                  round = TRUE,
                  ticks = FALSE
                 ),
      radioButtons("metric", label = "AMC metric:",
                   selected = character(0),
                   choices = unique(data_for_report$metric)),
      conditionalPanel(
        condition = "input.metric == null", 
        helpText("Please select metric")
      )
    ),
    
    # outputs
    plotlyOutput("bar_plot"),
    tableOutput("table")
    
  ),
  
  server = function(session, input, output) {
  
    # filter data based on inputs
    data <- reactive({
      data_for_report
    })
    
    filter1_country <- reactive({
      req(input$country)
      
      subset <- data() %>%
        filter(country == input$country)
      subset
    })
    
    filter2_route <- reactive({
      req(input$country, input$route)
      
      subset <- filter1_country() %>%
        filter(route_of_administration == input$route)
      subset
    })
    
    filter3_aware <- reactive({
      req(input$country, input$route, input$aware)
      
      subset <- filter2_route() %>%
        filter(aware_category == input$aware)
      subset
    })
    
    filter4_year <- reactive({
      req(input$country, input$route, input$aware, input$year)
      
      subset <- filter3_aware() %>%
        filter(year %in%  seq(min(input$year, na.rm = T), max(input$year, na.rm = T)))
      subset
    })
    
    filter5_metric <- reactive({
      req(input$country, input$route, input$aware, input$year, input$metric)
      
      subset <- filter4_year() %>%
        filter(metric == input$metric)
      subset
    })
    
    # update input options based on user selections
    observe({
      req(input$country)
      
      D <- filter1_country() #i.e., already filtered on country
      updateSelectInput(session, inputId = "route",
                        label = "Route of administration:",
                        choices = c("", sort(unique(D$route_of_administration))),
                        selected = NULL)
    })
    
    observe({
      req(input$country, input$route)
      
      D <- filter2_route()
      updateSelectInput(session, inputId = "aware",
                        label = "AWaRe category:",
                        choices = c("", sort(unique(D$aware_category))),
                        selected = NULL)
    })
    
    observe({
      req(input$country, input$route, input$aware)
      
      D <- filter3_aware()
      updateSliderInput(session, inputId = "year",
                        label = "Year(s):",
                        value = c(min(D$year, na.rm = T), max(D$year, na.rm = T)),
                        min = min(D$year, na.rm = T),
                        max = max(D$year, na.rm = T))
    })
    
    observe({
      req(input$country, input$route, input$aware, input$year)
      
      D <- filter4_year()
      updateRadioButtons(session, inputId = "metric",
                        label = "AMC metric:",
                        selected = character(0),
                        choices = unique(D$metric))
    })

    # bar plot
    output$bar_plot <- renderPlotly({
      
      DATA <- filter5_metric() %>%
        group_by(country, route_of_administration, aware_category, metric, corporation, corp_amr_alliance, corp_ifpma) %>%
        mutate(AMC = sum(value) / length(unique(year))) %>%
        select(country, route_of_administration, aware_category, metric, corporation, corp_amr_alliance, corp_ifpma, AMC) %>%
        unique() %>%
        ungroup()
      
      DATA <- DATA %>%
        mutate(percent = round((AMC/sum(AMC))*100, 5))
        
      DATA <- DATA[order(-DATA$percent, DATA$corporation), ] %>%
        mutate(cumulative = cumsum(percent)) %>%
        filter(cumulative <= 90) %>%
        mutate(corp_group = "",
               corp_group = case_when(
                              corp_amr_alliance == "true" & corp_ifpma == "false" ~ "AMR alliance only",
                              corp_amr_alliance == "false" & corp_ifpma == "true" ~ "IFPMA only",
                              corp_amr_alliance == "true" & corp_ifpma == "true" ~ "both",
                              corp_amr_alliance == "false" & corp_ifpma == "false" ~ "neither",
                              TRUE ~ as.character(corp_group)
                            )
               )
  
      percent_corp_groups <- DATA %>%
        mutate(count_amr = case_when(corp_amr_alliance == "true" & corp_ifpma == "false" ~ 1),
               count_ifpma = case_when(corp_amr_alliance == "false" & corp_ifpma == "true" ~ 1),
               count_both = case_when(corp_amr_alliance == "true" & corp_ifpma == "true" ~ 1),
               count_neither = case_when(corp_amr_alliance == "false" & corp_ifpma == "false" ~ 1))
    
      bar_plot <-
        ggplot(DATA, aes(x = reorder(corporation, cumulative), y = AMC, fill = corp_group)) +
        geom_bar(stat = "identity") +
        labs(x = "", y = ifelse(input$metric == "ddd", "DDD", "SU"), 
             # caption = paste0(round((sum(percent_corp_groups$count_amr, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% AMR alliance only; ", 
             #                  round((sum(percent_corp_groups$count_ifpma, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% IFPMA only; ",
             #                  round((sum(percent_corp_groups$count_both, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% both; ", 
             #                  round((sum(percent_corp_groups$count_neither, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% neither."
             #                 ), 
             fill = NULL) +
        theme(axis.text.x=element_text(angle=45, hjust=.5), plot.caption = element_text(color = "red", face = "italic", hjust = 0))
      
      bar_plotly <- ggplotly(bar_plot) %>%
        layout(annotations = list(x = 1, y = 0.9,
                                  xref = 'paper', yref = 'paper', showarrow = F, 
                                  xanchor = 'right', yanchor = 'auto', xshift = 0, yshift = 0,
                                  font = list(size = 12, color = "blue"),
                                  text = paste0(round((sum(percent_corp_groups$count_amr, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% AMR alliance only; ", 
                                                round((sum(percent_corp_groups$count_ifpma, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% IFPMA only; ",
                                                round((sum(percent_corp_groups$count_both, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% both; ", 
                                                round((sum(percent_corp_groups$count_neither, na.rm = T)/length(unique(percent_corp_groups$corporation)))*100, 2), "% neither."
                             )))
      
    })
    
    # table
    output$table <- renderTable({
      
      DATA <- filter5_metric() %>%
        group_by(country, route_of_administration, aware_category, metric, corporation, corp_amr_alliance, corp_ifpma) %>%
        mutate(AMC = sum(value) / length(unique(year))) %>%
        select(country, route_of_administration, aware_category, metric, corporation, corp_amr_alliance, corp_ifpma, AMC) %>%
        unique() %>%
        ungroup()
      
      DATA <- DATA %>%
        mutate(percent = round((AMC/sum(AMC))*100, 5))
        
      DATA <- DATA[order(-DATA$percent, DATA$corporation), ] %>%
        mutate(cumulative = cumsum(percent)) %>%
        filter(cumulative <= 90) %>%
        mutate(corp_group = "",
               corp_group = case_when(
                              corp_amr_alliance == "true" & corp_ifpma == "false" ~ "AMR alliance only",
                              corp_amr_alliance == "false" & corp_ifpma == "true" ~ "IFPMA only",
                              corp_amr_alliance == "true" & corp_ifpma == "true" ~ "both",
                              corp_amr_alliance == "false" & corp_ifpma == "false" ~ "neither",
                              TRUE ~ as.character(corp_group)
                            )
               )
      
      table <- DATA %>% select(corporation, percent, corp_group) %>% arrange(desc(percent))
      
    })
  
  },
  
  options = list(width = 950, height = 1000)
  
)
```